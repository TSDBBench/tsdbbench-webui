{% extends "index.html" %}

{% block title %}TSDBBench Web UI{% endblock %}

{% block main_page_heading %}

    <!-- Page Heading -->
    <div class="row">
        <div class="col-lg-12">
            <h1 class="page-header">
                Benchmark control
            </h1>
            <ol class="breadcrumb">
                <li class="active">
                    <i class="fa fa-dashboard"></i> Dashboard
                </li>
            </ol>
        </div>
    </div>
    <!-- /.row -->

{% endblock main_page_heading %}

{% block page_content %}

<style type="text/css">
.iframe_container {
    position: relative;
    padding-bottom: 75%;
    height: 0;
    overflow: hidden;
}

.iframe_container iframe {
    position: absolute;
    top:0;
    left: 0;
    width: 100%;
    height: 100%;
}
</style>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
<script type="text/underscore" id="iframeTabTemplate">
<div class="tab-pane <% if(obj.result_id == 0) { %>active<% } %>" id="<%= obj.result_id %>">    
    <div class="iframe_container">
        <iframe width="1700px" height="800px" style="border-width:0" frameborder="0" src="<%= obj.result_link %>"></iframe>
    </div>
</div>
</script>


<div class="row">

    <div class="">
        <h3>Benchmark results</h3>
        <button onclick="start_benchmark">Start Benchmark</button>
        <!-- result tabs -->
        <div class="tabbable">
            <!-- Tab menu items -->
            <ul class="nav nav-pills row" id="results_tab_menu">
            </ul>
            <!-- Tab pages -->
            <div class="tab-content row" id="results_container">
            </div>
        </div>
        <!-- /result tabs -->
    </div>

</div>

<script type="text/javascript">
// testResults = [];
// testResults.push("http://192.168.209.154/TSDBBench/ycsb_combined_201701231253.html");
// testResults.push("http://192.168.209.154/TSDBBench/ycsb_mysql_cl1_rf1_testworkloada_201701231249.html");
// testResults.push("http://192.168.209.154/TSDBBench/ycsb_combined_201701231253.html");

var start_benchmark = function() {
    // var progressUpdateIntervalId = setInterval(get_new_benchmark_progress_messages, 2000);

    // setTimeout(1000, get_benchmark_progress_messages());
    $.ajax({
      url: "http://localhost:5000/benchmark",
      type: 'POST',
      success: function (response) {
        responseRaw = response;
        console.log(response);
        render_results(response);
        // clearInterval(progressUpdateIntervalId);
      },
      error: function (response) {
        console.log(response);
        responseObject = JSON.parse(response);
        console.log(responseObject);
      }
    });
};

var release_floating_ips = function () {
    $.ajax({
      url: "http://localhost:5000/releasefloatingips",
      type: 'POST',
      success: function (response) {
        console.log(response);
      },
      error: function (response) {
        console.log(response);
      }
    });
};

var get_new_benchmark_progress_messages = function() {
    console.log("fetching new progress messages");
    $.ajax({
      url: "http://localhost:5000/benchmark_progress", //todo dynamic backend ip
      type: 'POST',
      success: function (response) {
        console.log(response);
        for (var index in response) {
            $("output").append("<p>" + response[index] + "</p>");
        }
        // responseObject = JSON.parse(response);
        // console.log(responseObject);
      },
      error: function (response) {
        console.log(response);
        responseObject = JSON.parse(response);
        console.log(responseObject);
      }
    });
};

var get_benchmark_progress_messages = function() {
    $.ajax({
      url: "http://localhost:5000/benchmark_progress", //todo dynamic backend ip
      type: 'GET',
      success: function (response) {
        console.log(response);
        // for (var index in response) {
        //     $("output").append("<p>" + response[index] + "</p>");
        // }
        // responseObject = JSON.parse(response);
        // console.log(responseObject);
      },
      error: function (response) {
        console.log(response);
        responseObject = JSON.parse(response);
        console.log(responseObject);
      }
    });
};

var render_results = function(testResults) {
    $("#results_tab_menu").empty();
    $("#results_container").empty();
    for (var index = 0; index < testResults.length; index++) {
        result_link = "http://192.168.209.154/TSDBBench/" + testResults[index];
        resultObject = {};
        resultObject.result_link = result_link;
        resultObject.result_id = index;
        display_result(resultObject);
    };
};

var display_result = function(resultObject) {
    var tabMenuItemClass = "";
    if(resultObject.result_id == 0) {
        tabMenuItemClass = "active"
    }
    var resultTabMenuItem = $("<li class='" + tabMenuItemClass + "'><a href='#" + resultObject.result_id + "' data-toggle='tab'>Result #" + resultObject.result_id + "</a></li>");
    $("#results_tab_menu").append(resultTabMenuItem);

    var iframeTabTemplateRaw = $("#iframeTabTemplate").html();
    var templateElement = _.template(iframeTabTemplateRaw);
    var compiledElement = templateElement(resultObject);
    var iframeTabElement = $(compiledElement);
    $("#results_container").append(iframeTabElement);
};
</script>

{% endblock page_content %}